name: Generate Widoco Documentation

on:
  push:
    branches:
      - main
    paths:
      - "OSDi.ttl"   # Only trigger when the ontology file changes
  workflow_dispatch: # allows manual execution from GitHub
  
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Clone the repository
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}
          
      # 2. Install Java (required for Widoco)
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Download Widoco (latest release)
      - name: Download Widoco
        run: |
          wget https://github.com/dgarijo/Widoco/releases/download/v1.4.25/widoco-1.4.25-jar-with-dependencies_JDK-11.jar -O widoco.jar

      # 4. Extract version from TTL file
      - name: Extract version from TTL
        id: version
        run: |
          VERSION=$(grep -oP 'owl:versionIRI\s*<[^>]+/(\K[^>/]+)' OSDi.ttl | head -n 1)
          if [ -z "$VERSION" ]; then
            echo "âŒ Version not found in owl:versionIRI in OSDi.ttl"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

      # 5 Clean docs/latest directory
      - name: Reset docs/latest directory
        run: |
          rm -rf docs/latest
          mkdir -p docs/latest

      # 6. Run Widoco
      - name: Generate documentation with Widoco
        run: |
          java -jar widoco.jar \
            -ontFile OSDi.ttl \
            -outFolder docs/latest \
            -rewriteAll \
            -lang en-es \
            -uniteSections \
            -includeAnnotationProperties

      # 7. Copy individuals folder if it has changes
      - name: Copy individuals folder
        if: ${{ hashFiles('individuals/**') != '' }}
        run: |
          mkdir -p docs/latest/individuals
          cp -R individuals/* docs/latest/individuals/

      # 8. Copy versioned documentation
      - name: Copy versioned documentation
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p docs/$VERSION
          cp -R docs/latest/* docs/$VERSION/

      # 9. Commit and push only if there are real changes
      - name: Commit and push only if changes exist
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          # Verificar si hay cambios en docs/
          if git diff --quiet docs; then
            echo "No changes in docs/, skipping commit"
          else
            git add docs
            git commit -m "Auto-update documentation (version ${{ steps.version.outputs.version }} + latest)" || echo "No changes to commit"
            git pull --rebase origin main
            git push https://x-access-token:${PAT_TOKEN}@github.com/ontologies-ULL/OSDi.git HEAD:main
          fi
